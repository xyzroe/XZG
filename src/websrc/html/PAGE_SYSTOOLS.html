<div id='main'>
  <ul class="nav nav-tabs nav-fill mb-3" role="tablist" style="flex-wrap: inherit;">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#systemControl" type="button"
        role="tab" aria-controls="home" aria-selected="true"><svg class="me-1" xmlns="http://www.w3.org/2000/svg"
          width="16" height="16" fill="currentColor" class="bi bi-sliders" viewBox="0 0 16 16">
          <use xlink:href="icons.svg#systemControl" />
        </svg>System Control</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#systemTools" type="button"
        role="tab" aria-controls="profile" aria-selected="false" onclick="$('.masonry').masonry()"><svg class="me-1"
          xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-tools"
          viewBox="0 0 16 16">
          <use xlink:href="icons.svg#systemTools" />
        </svg>System Tools</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="fw-tab" data-bs-toggle="tab" data-bs-target="#firmwareUpdate" type="button"
        role="tab" aria-controls="fw" aria-selected="false" onclick="$('.masonry').masonry()"><svg class="me-1"
          xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-tools"
          viewBox="0 0 16 16">
          <use xlink:href="icons.svg#download" />
        </svg>Firmware update</button>
    </li>
  </ul>

  <div class="tab-content">

    <div class="tab-pane fade show active" id="systemControl" role="tabpanel" aria-labelledby="home-tab">
      <div class="row masonry" data-masonry='{"percentPosition": true }'>

        <div class="col-sm-12 col-md-6 mb-4">
          <div class='card'>
            <div class='card-header'>System vars</div>
            <div class='card-body'>
              <div class="container">
                <form class="saveParams" method='POST' action="saveParams">
                  <div class="row">
                    <label for="hostname">Hostname. Device will be displayed in the network with
                      this name</label>
                    <input data-replace="hostname" class="form-control" id="hostname" type="text" name="hostname"
                      value="" maxlength="50" required>
                    <label for='refreshLogs'>Console log refresh interval</label>
                    <input data-replace="refreshLogs" class='form-control' id='refreshLogs' type="number" min="1000"
                      max="10000" step="1" name='refreshLogs' value='' placeholder="in milliseconds" required>
                    <div class="col">
                      <div class="row justify-content-md-center mt-2">
                        <button type="submit" class="btn btn-outline-primary col-sm-12 col-md-6">Set</button>
                      </div>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-12 col-md-6 mb-4">
          <div class='card'>
            <div class='card-header'>Modules control</div>
            <div class='card-body'>
              <div class="row" style="display: flex; align-items: center; justify-content: center;">
                <button type='button' data-cmd="1"
                  class='btn btn-outline-primary col-sm-12 col-md-auto mb-1 me-1'>Zigbee Restart</button>
                <button type='button' data-cmd="2"
                  class='btn btn-outline-primary col-sm-12 col-md-auto mb-1 me-1'>Zigbee Flash Mode</button>
                <button type='button' data-cmd="0"
                  class='btn btn-outline-primary col-sm-12 col-md-auto mb-1 me-1'>Router Reconnect</button>
              </div>
              <div class="row" style="display: flex; align-items: center; justify-content: center;">
                <button type='button' data-cmd="3" class='btn btn-outline-warning col-sm-12 col-md-auto mb-1 me-1'>ESP32
                  Restart</button>
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-12 col-md-6 mb-4">
          <div class='card'>
            <div class='card-header'>Current session control</div>
            <div class='card-body'>
              <div class="row" style="display: flex; align-items: center; justify-content: center;">
                <button type='button' data-cmd="4" class='btn btn-outline-primary col-sm-12 col-md-auto mb-1 me-1'>LAN
                  Mode ON</button>
                <button type='button' data-cmd="5" class='btn btn-outline-primary col-sm-12 col-md-auto mb-1 me-1'>USB
                  Mode ON</button>
              </div>
              <div class="row" style="display: flex; align-items: center; justify-content: center;">
                <button type='button' data-cmd="6" class='btn btn-info col-sm-12 col-md-auto mb-1 me-1'>BLUE ðŸ’¡
                  Toggle</button>
                <button type="button" data-cmd="7" class="btn btn-danger col-sm-12 col-md-auto mb-1 me-1">RED ðŸ’¡
                  Toggle</button>
                <button type="button" data-cmd="12" class="btn btn-warning col-sm-12 col-md-auto mb-1 me-1">YELLOW ðŸ’¡
                  Toggle</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="tab-pane fade" id="systemTools" role="tabpanel" aria-labelledby="profile-tab">
      <div class="row masonry" data-masonry='{"percentPosition": true }'>

        <div class="col-sm-12 col-md-6 mb-4">
          <div class='card'>
            <div class='card-header'>Debug console</div>
            <div class='card-body'>
              <div class="row">
                <div class="col">
                  <div class="col-sm-12">Raw data :</div>
                  <textarea class="form-control col-sm-12 mb-2" id="console" rows="8"></textarea>
                  <button type="button" data-cmd="8" onclick="$('console').val('')"
                    class="btn btn-outline-primary col-sm-12 col-md-auto mb-1 me-1">Clear Console</button>
                  <button type="button" data-cmd="11"
                    class="btn btn-outline-accent2 col-sm-12 col-md-auto mb-1 me-1">Check
                    Zigbee connection</button>
                  <button type="button" data-cmd="10"
                    class="btn btn-outline-success col-sm-12 col-md-auto mb-1 me-1">Check
                    Zigbee revision</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-12 col-md-6 mb-4">
          <div class='card'>
            <div class='card-header'>File Browser</div>
            <div class='card-body'>
              <table id="filelist" class="table">
                <thead>
                  <tr>
                    <th scope="col">Filename</th>
                    <th scope="col">Size</th>
                  </tr>
                </thead>
              </table>
              <form method="POST" action="saveFile">
                <div class="form-group">
                  <div><label for="file">File : <span id="title"></span></label><input type="hidden" name="filename"
                      id="filename" value=""></div><textarea class="form-control mb-2" id="config_file" name="file"
                    rows="10"></textarea>
                </div><button type="submit" class="btn btn-outline-primary col-sm-12 col-md-6">Save</button>
              </form>
            </div>
          </div>
        </div>

        <!--<div class="col-sm-12 col-md-6 mb-4">
          <div class='card'>
            <div class='card-header'>Tests</div>
            <div class='card-body'>
              <div class="row">
                <div class="col">
                  <label for="zbFirmware" class="form-label">Select firmware file</label>
                  <input class="form-control" type="file" id="zbFirmware" accept=".hex">
                  <button type="button" onclick="zbOta()" class="btn btn-warning col-sm-12 col-md-6">Update Zigbee
                    firmware</button>
                  <div class="mt-3">
                    <input class="form-control col-sm-6" id="sendHex" type="text" name="sendHex" value="" maxlength="50"
                      placeholder="Send hex to zigbee module">
                    <button type="button" onclick="sendHex()"
                      class="btn btn-outline-primary col-sm-3 mt-2">Send</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>-->

      </div>
    </div>

    <div class="tab-pane fade" id="firmwareUpdate" role="tabpanel" aria-labelledby="fw-tab">
      <div class="row masonry" data-masonry='{"percentPosition": true }'>
        <div class="col-sm-12 col-md-6 mb-4">
          <div class='card'>
            <div class='card-header'>ESP32 update</div>
            <div class='card-body'>
              <form class="container" method='POST' action='#' enctype='multipart/form-data' id='upload_form'>
                <input type='file' name='update' id='file' onchange='sub(this)' style=display:none accept='.bin'>
                <label id='file-input' for='file'> Choose file...</label>
                <input id="updButton" type='submit' class='btn btn-warning mb-2' value='ESP32 file update' disabled>
                <br>
                <div class="container" style="max-width: 300px; margin-top: 30px;">
                  <div id='prg'></div>
                  <div id='prgbar'>
                    <div id='bar'></div>
                  </div>
                </div>
                <br>
                <div class="container" style="max-width: 300px; margin-top: 15px;">
                  <div class="row">
                    <button type="button" id="upd_esp_git" class="btn btn-warning col-sm-12 mb-2">Install latest from
                      Github</button>
                  </div>
                  <div class="row">
                    <button type="button" id="info_esp_git" class="btn btn-outline-warning col-sm-12 flsh_esp mb-2">Show
                      verison info</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!--<div class="col-sm-12 col-md-6 mb-4">
          <div class='card'>
            <div class='card-header'>Zigbee update</div>
            <div class='card-body'>
              <form class="container" method='POST' action='#' enctype='multipart/form-data' id='upload_form_zb'>
                <input type='file' name='update_zb' id='file_zb' onchange='sub_zb(this)' style=display:none
                  accept='.hex'>
                <label id='file-input_zb' for='file_zb'> Choose file...</label>
                <input id="updButton_zb" type='submit' class='btn btn-primary mb-2' value='Zigbee file update' disabled>
                <br>
                <div id='prg_zb'></div>
                <div id='prgbar_zb'>
                  <div id='bar_zb'></div>
                </div>
              </form>
            </div>
          </div>
        </div>  data-cmd="9"  -->

        <!-- <div class="col-sm-12 col-md-6 mb-4">
          <div class='card'>
            <div class='card-header'>ESP32 OTA online update</div>
            <div class='card-body'>
              <div class="container" style="max-width: 400px;">
                <div class="row">
                  <button type="button" id="upd_esp_git" class="btn btn-warning col-sm-12 mb-2">Install latest from Github</button>
                </div>
                <div class="row">
                  <button type="button" class="btn btn-outline-warning col-sm-12 flsh_esp mb-2">Show changelog</button>
                </div>
              </div>
            </div>
          </div>
        </div> -->

        <!-- <div class="col-sm-12 col-md-6 mb-4">
          <div class='card'>
            <div class='card-header'>Zigbee OTA online update</div>
            <div class='card-body'>
              <div class="container" style="max-width: 400px;">
                <div class="row">
                  <button type="button" class="btn btn-primary col-sm-12 flsh_zb mb-2">Check for updates</button>
                </div>
              </div>
            </div>
          </div>
        </div> -->

      </div>
    </div>

    <script src="/js/masonry.js"></script>
    <script>
      $(".flsh_zb").click(function () {//http://192.168.0.105/api?action=10&fwurl=https://raw.githubusercontent.com/Tarik2142/devHost/main/coordinator_20220219.bin
        //alert("Feature under development");
        modalConstructor("flashZB");//
        //apiLink + api.actions.API_FLASH_ZB + "&fwurl=" + "https://raw.githubusercontent.com/Tarik2142/devHost/main/" + this.id + ".bin"
      });
      function sub(obj) {
        let fileName = obj.value.split('\\\\');
        if (fileName != "") {
          $("#updButton").removeAttr("disabled");
          localStorage.setItem('beta_feedback', 0);
          /* if (!(localStorage.getItem('flash_warning') == 1)) {
            modalConstructor("flashWarning");
          } else {
            $("#updButton").removeAttr("disabled");
          } */
        }
        else {
          $("#updButton").prop(disbl, 1);
        }
        document.getElementById('file-input').innerHTML = '   ' + fileName[fileName.length - 1];
      };
      function sub_zb(obj) {
        let fileName = obj.value.split('\\\\');
        if (fileName != "") {
          $("#updButton_zb").removeAttr("disabled");
        }
        else {
          $("#updButton_zb").prop(disbl, 1);
        }
        document.getElementById('file-input_zb').innerHTML = '   ' + fileName[fileName.length - 1];
      };
      $('form#upload_form').submit(function (e) {
        e.preventDefault();
        var form = $('#upload_form')[0];
        var data = new FormData(form);

        ESPfwStartEvents();

        //setTimeout(function () {
        //	$.get(apiLink + api.actions.API_CMD + "&cmd=9", function (data) { });
        //	console.log("[flash] start");
        //	$('#prg').html('Github download starting...');
        //}, 500);

        $.ajax({
          url: '/update',
          type: 'POST',
          data: data,
          contentType: false,
          processData: false,
          xhr: function () {
            var xhr = new window.XMLHttpRequest();
            //xhr.upload.addEventListener('progress', function (evt) {
            //  if (evt.lengthComputable) {
            //    var per = evt.loaded / evt.total;
            //    $('#prg').html('progress: ' + Math.round(per * 100) + '%');
            //    $('#bar').css('width', Math.round(per * 100) + '%');
            //  }
            //}, false);

            return xhr;
          },
          success: function (d, s) {
            console.log('success!');
            //$('#prg').html('Update completed!<br>Rebooting!');
            //window.location.href = '/';
            //rebootWait();
          },
          error: function (a, b, c) {
          }
        });
      });
      $('form#upload_form_zb').submit(function (e) {
        e.preventDefault();
        var form = $('#upload_form_zb')[0];
        var data = new FormData(form);
        $.ajax({
          url: '/updateZB',
          type: 'POST',
          data: data,
          contentType: false,
          processData: false,
          xhr: function () {
            var xhr = new window.XMLHttpRequest();
            xhr.upload.addEventListener('progress', function (evt) {
              if (evt.lengthComputable) {
                var per = evt.loaded / evt.total;
                $('#prg_zb').html('upload: ' + Math.round(per * 100) + '%');
                $('#bar_zb').css('width', Math.round(per * 100) + '%');
              }
            }, false);
            return xhr;
          },
          success: function (d, s) {
            console.log('success!');
            $('#prg_zb').html('Upload completed! Start flashing...');
            $('#bar_zb').css('width', '0%');
            //window.location.href = '/';
            //rebootWait();
          },
          error: function (a, b, c) {
          }
        });
      });


      $('button#upd_esp_git').click(function () {

        console.log('Update from Git started... Just be patient!');
        localStorage.setItem('update_notify', 0);
        espFlashGitWait();

      });
    </script>
    <script src="https://unpkg.com/commonmark@0.29.3/dist/commonmark.js"></script>
    <script>

      $('button#info_esp_git').click(function () {
        

        processResponses().then(combinedData => {

          var asset = combinedData.jsonData.assets[0];
          var downloadCount = 0;
          for (var i = 0; i < combinedData.jsonData.assets.length; i++) {
            downloadCount += combinedData.jsonData.assets[i].download_count;
          }
          var text = "Local version is v" + combinedData.textData + ". GitHub version is " + combinedData.jsonData.tag_name + " and it was downloaded " + downloadCount.toLocaleString() + " times. It's your turn now ðŸš€";
          
          var reader = new commonmark.Parser();
          var writer = new commonmark.HtmlRenderer();
          var parsed = reader.parse(combinedData.jsonData.body);
          var chglog = writer.render(parsed); 
          
          modalConstructor("espFlashGitInfo", { text, chglog });
        });
      });


    </script>
  </div>